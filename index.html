<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de Vinculación de Cliente</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de la fuente Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Estilo personalizado para la fuente Inter */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Estilo para el loader */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-xl p-8 sm:p-10">
        
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Formulario de Vinculación de Cliente</h1>
            <p class="mt-2 text-gray-600">Completa los 4 pasos para registrar tu empresa. Puedes usar la IA para pre-llenar el formulario desde tus documentos.</p>
        </header>

        <!-- Mensaje de estado (éxito/error) -->
        <div id="message" class="hidden mb-6 p-4 rounded-md text-sm"></div>

        <form id="onboardingForm">
            <!-- Paso 1: Carga de Documentos -->
            <section class="border border-gray-200 rounded-lg p-6 mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-5">Paso 1: Cargar Documentos</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="fileConstitucion" class="block text-sm font-medium text-gray-700 mb-1">1. Certificado de Constitución Legal</label>
                        <input type="file" id="fileConstitucion" accept=".pdf,.jpg,.jpeg,.png" class="block w-full text-sm text-gray-500
                            file:mr-4 file:py-2 file:px-4
                            file:rounded-full file:border-0
                            file:text-sm file:font-semibold
                            file:bg-blue-50 file:text-blue-700
                            hover:file:bg-blue-100 cursor-pointer" required>
                    </div>
                    <div>
                        <label for="fileLegal" class="block text-sm font-medium text-gray-700 mb-1">2. Documento Representación Legal</label>
                        <input type="file" id="fileLegal" accept=".pdf,.jpg,.jpeg,.png" class="block w-full text-sm text-gray-500
                            file:mr-4 file:py-2 file:px-4
                            file:rounded-full file:border-0
                            file:text-sm file:font-semibold
                            file:bg-blue-50 file:text-blue-700
                            hover:file:bg-blue-100 cursor-pointer" required>
                    </div>
                </div>
                <div class="mt-6 text-center">
                    <button type="button" id="extractButton" class="inline-flex items-center justify-center w-full sm:w-auto px-6 py-3 border border-transparent text-base font-medium rounded-lg shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.25 12l.813-2.846a4.5 4.5 0 00-3.09-3.09L13.125 5.25l-.813 2.846a4.5 4.5 0 00-3.09 3.09L6.375 12l2.846.813a4.5 4.5 0 003.09 3.09L13.125 18.75l.813-2.846a4.5 4.5 0 003.09-3.09L19.75 12l-2.846-.813z" />
                        </svg>
                        <span id="buttonText">Analizar Documentos y Pre-llenar Formulario</span>
                        <div id="loader" class="loader hidden ml-3"></div>
                    </button>
                    <p class="text-xs text-gray-500 mt-2">Usa IA para leer los documentos y llenar los campos automáticamente.</p>
                </div>
            </section>

            <!-- Paso 2: Información de la Empresa (Pre-llenado por IA) -->
            <section class="mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-5">Paso 2: Verificar Información de la Empresa</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5">
                    <!-- Campos del formulario PDF -->
                    <div>
                        <label for="razonSocial" class="block text-sm font-medium text-gray-700">Razón Social o Nombre Completo</label>
                        <input type="text" id="razonSocial" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="Extraído por IA...">
                    </div>
                    <div>
                        <label for="tipoIdentificacion" class="block text-sm font-medium text-gray-700">Tipo de Identificación (Ej. NIT, RUT)</label>
                        <input type="text" id="tipoIdentificacion" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="Extraído por IA...">
                    </div>
                    <div>
                        <label for="numeroIdentificacion" class="block text-sm font-medium text-gray-700">Número de Identificación</label>
                        <input type="text" id="numeroIdentificacion" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="Extraído por IA...">
                    </div>
                    <div>
                        <label for="tipoPersona" class="block text-sm font-medium text-gray-700">Tipo de Persona (Natural / Jurídica)</label>
                        <input type="text" id="tipoPersona" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="Extraído por IA...">
                    </div>
                    <div class="md:col-span-2">
                        <label for="direccionFiscal" class="block text-sm font-medium text-gray-700">Dirección Fiscal</label>
                        <input type="text" id="direccionFiscal" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="Extraído por IA...">
                    </div>
                    <div>
                        <label for="pais" class="block text-sm font-medium text-gray-700">País</label>
                        <input type="text" id="pais" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="Extraído por IA...">
                    </div>
                    <div>
                        <label for="region" class="block text-sm font-medium text-gray-700">Región / Departamento</label>
                        <input type="text" id="region" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="Extraído por IA...">
                    </div>
                     <div>
                        <label for="telefonoFijo" class="block text-sm font-medium text-gray-700">Teléfono Fijo</label>
                        <input type="tel" id="telefonoFijo" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="Extraído por IA...">
                    </div>
                    <div>
                        <label for="paginaWeb" class="block text-sm font-medium text-gray-700">Página Web</label>
                        <input type="url" id="paginaWeb" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="Extraído por IA...">
                    </div>
                    <div class="md:col-span-2"><hr class="my-2"></div>
                    <div>
                        <label for="nombreRepLegal" class="block text-sm font-medium text-gray-700">Nombre del Representante Legal</label>
                        <input type="text" id="nombreRepLegal" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="Extraído por IA...">
                    </div>
                    <div>
                        <label for="cargoRepLegal" class="block text-sm font-medium text-gray-700">Cargo del Representante Legal</label>
                        <input type="text" id="cargoRepLegal" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="Extraído por IA...">
                    </div>
                    <div>
                        <label for="telefonoRepLegal" class="block text-sm font-medium text-gray-700">Teléfono o Celular del Rep. Legal</label>
                        <input type="tel" id="telefonoRepLegal" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="Extraído por IA...">
                    </div>
                    <div>
                        <label for="emailRepLegal" class="block text-sm font-medium text-gray-700">E-mail del Representante Legal</label>
                        <input type="email" id="emailRepLegal" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="Extraído por IA...">
                    </div>
                </div>
            </section>

            <!-- Paso 3: Contactos de Facturación (Llenado Manual) -->
            <section class="mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-5">Paso 3: Completar Contactos de Facturación</h2>
                <div class="space-y-6">
                    <!-- Contacto Cuentas por Pagar -->
                    <fieldset class="border border-gray-200 rounded-lg p-5">
                        <legend class="text-base font-medium text-gray-900 px-2">Contacto Cuentas por Pagar y/o Tesorería</legend>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-4">
                            <div>
                                <label for="contactoAPNombre" class="block text-sm font-medium text-gray-700">Nombre Contacto</label>
                                <input type="text" id="contactoAPNombre" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" required>
                            </div>
                            <div>
                                <label for="contactoAPEmail" class="block text-sm font-medium text-gray-700">E-mail</label>
                                <input type="email" id="contactoAPEmail" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" required>
                            </div>
                            <div>
                                <label for="contactoAPTelefono" class="block text-sm font-medium text-gray-700">Teléfono</label>
                                <input type="tel" id="contactoAPTelefono" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" required>
                            </div>
                        </div>
                    </fieldset>
                    <!-- Contacto Financiero -->
                     <fieldset class="border border-gray-200 rounded-lg p-5">
                        <legend class="text-base font-medium text-gray-900 px-2">Contacto Financiero</legend>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-4">
                            <div>
                                <label for="contactoFinNombre" class="block text-sm font-medium text-gray-700">Nombre Contacto</label>
                                <input type="text" id="contactoFinNombre" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="contactoFinEmail" class="block text-sm font-medium text-gray-700">E-mail</label>
                                <input type="email" id="contactoFinEmail" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="contactoFinTelefono" class="block text-sm font-medium text-gray-700">Celular</label>
                                <input type="tel" id="contactoFinTelefono" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            </div>
                        </div>
                    </fieldset>
                </div>
            </section>

            <!-- Paso 4: Declaraciones -->
            <section class="mb-10">
                <h2 class="text-xl font-semibold text-gray-800 mb-5">Paso 4: Declaraciones Finales</h2>
                <div class="space-y-5">
                    <div class="relative flex items-start">
                        <div class="flex items-center h-5">
                            <input id="pepDeclaration" name="pepDeclaration" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" required>
                        </div>
                        <div class="ml-3 text-sm">
                            <label for="pepDeclaration" class="font-medium text-gray-700">Declaración de Persona Políticamente Expuesta (PEP)</label>
                            <p class="text-gray-500">Declaro bajo la gravedad de juramento que ni yo, ni los socios, ni los beneficiarios finales de la empresa somos personas políticamente expuestas (PEP) o hemos sido catalogados como tal.</p>
                        </div>
                    </div>
                    <div class="relative flex items-start">
                        <div class="flex items-center h-5">
                            <input id="truthDeclaration" name="truthDeclaration" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" required>
                        </div>
                        <div class="ml-3 text-sm">
                            <label for="truthDeclaration" class="font-medium text-gray-700">Certificación de Veracidad</Ttxlabel>
                            <p class="text-gray-500">Certifico que toda la información presentada en este formulario es fidedigna, completa y precisa.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Botón de Envío -->
            <div class="pt-6 border-t border-gray-200">
                <div class="flex justify-end">
                    <button type="submit" class="w-full sm:w-auto px-8 py-3 border border-transparent text-base font-medium rounded-lg shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        Enviar Formulario
                    </button>
                </div>
            </div>
        </form>
    </div>

    <script>
        // --- Variables de la API de Gemini ---
        // La API Key se deja vacía; el entorno la proporcionará en tiempo de ejecución.
        const apiKey = ""; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // --- Definición del Esquema JSON ---
        // Este esquema le dice a la IA qué campos exactos queremos extraer.
        // Se basa en los campos del PDF adjunto.
        const schema = {
            type: "OBJECT",
            properties: {
                razonSocial: { type: "STRING", description: "Razón Social o Nombre Completo de la empresa" },
                tipoPersona: { type: "STRING", description: "Jurídica o Natural" },
                tipoIdentificacion: { type: "STRING", description: "Tipo de identificación fiscal, ej: NIT, RUT, CUIT" },
                numeroIdentificacion: { type: "STRING", description: "El número de identificación fiscal" },
                direccionFiscal: { type: "STRING", description: "La dirección fiscal completa (calle, número, ciudad)" },
                pais: { type: "STRING" },
                region: { type: "STRING", description: "Región, Provincia o Departamento" },
                telefonoFijo: { type: "STRING" },
                paginaWeb: { type: "STRING" },
                nombreRepLegal: { type: "STRING", description: "Nombre completo del Representante Legal" },
                cargoRepLegal: { type: "STRING", description: "Cargo del Representante Legal (ej. CEO, Gerente General)" },
                telefonoRepLegal: { type: "STRING" },
                emailRepLegal: { type: "STRING" },
                actividadPrincipal: { type: "STRING", description: "Actividad económica principal de la empresa" },
            }
        };

        // --- Elementos del DOM ---
        const form = document.getElementById('onboardingForm');
        const extractButton = document.getElementById('extractButton');
        const loader = document.getElementById('loader');
        const buttonText = document.getElementById('buttonText');
        const messageDiv = document.getElementById('message');
        const fileConstitucionInput = document.getElementById('fileConstitucion');
        const fileLegalInput = document.getElementById('fileLegal');

        // --- Lógica de Eventos ---

        // Al hacer clic en el botón "Analizar Documentos"
        extractButton.addEventListener('click', handleExtractData);

        // Al enviar el formulario final
        form.addEventListener('submit', handleSubmit);

        /**
         * Función principal para manejar la extracción de datos.
         */
        async function handleExtractData() {
            const file1 = fileConstitucionInput.files[0];
            const file2 = fileLegalInput.files[0];

            if (!file1 || !file2) {
                showMessage('Por favor, carga ambos documentos antes de analizar.', 'error');
                return;
            }

            setLoading(true);
            showMessage('Analizando documentos... esto puede tardar un momento.', 'info');

            try {
                // 1. Convertir archivos a base64
                const [base64File1, base64File2] = await Promise.all([
                    fileToBase64(file1),
                    fileToBase64(file2)
                ]);

                // 2. Construir el prompt para la IA
                const prompt = `
                    Analiza estos dos documentos:
                    1. Un certificado de constitución legal.
                    2. Un documento de representación legal.

                    Extrae la información clave de la empresa basándote en el esquema JSON proporcionado. 
                    Si un campo no se encuentra, déjalo vacío. 
                    Devuelve únicamente el objeto JSON.
                `;

                // 3. Construir el payload de la API
                const payload = {
                    contents: [{
                        role: "user",
                        parts: [
                            { text: prompt },
                            { inlineData: { mimeType: file1.type, data: base64File1 } },
                            { inlineData: { mimeType: file2.type, data: base64File2 } }
                        ]
                    }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: schema
                    }
                };

                // 4. Llamar a la API (con reintentos)
                const result = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                // 5. Procesar la respuesta
                const jsonString = result.candidates[0].content.parts[0].text;
                const extractedData = JSON.parse(jsonString);

                // 6. Poblar el formulario
                populateForm(extractedData);
                
                showMessage('Formulario pre-llenado con éxito. Por favor, verifica la información.', 'success');

            } catch (error) {
                console.error('Error en la extracción:', error);
                showMessage('Error al analizar los documentos. Por favor, inténtalo de nuevo.', 'error');
            } finally {
                setLoading(false);
            }
        }

        /**
         * Rellena los campos del formulario con los datos extraídos por la IA.
         */
        function populateForm(data) {
            document.getElementById('razonSocial').value = data.razonSocial || '';
            document.getElementById('tipoPersona').value = data.tipoPersona || '';
            document.getElementById('tipoIdentificacion').value = data.tipoIdentificacion || '';
            document.getElementById('numeroIdentificacion').value = data.numeroIdentificacion || '';
            document.getElementById('direccionFiscal').value = data.direccionFiscal || '';
            document.getElementById('pais').value = data.pais || '';
            document.getElementById('region').value = data.region || '';
            document.getElementById('telefonoFijo').value = data.telefonoFijo || '';
            document.getElementById('paginaWeb').value = data.paginaWeb || '';
            document.getElementById('nombreRepLegal').value = data.nombreRepLegal || '';
            document.getElementById('cargoRepLegal').value = data.cargoRepLegal || '';
            document.getElementById('telefonoRepLegal').value = data.telefonoRepLegal || '';
            document.getElementById('emailRepLegal').value = data.emailRepLegal || '';
            // 'actividadPrincipal' no tiene un campo visible en este diseño, pero se extrae.
        }

        /**
         * Maneja el envío final del formulario.
         */
        function handleSubmit(e) {
            e.preventDefault();
            // Aquí iría la lógica para enviar los datos del formulario a un backend.
            // Por ahora, solo mostramos un mensaje de éxito.
            showMessage('¡Formulario enviado con éxito! Gracias por registrarte.', 'success');
            form.reset();
            window.scrollTo(0, 0);
        }

        // --- Funciones de Utilidad ---

        /**
         * Muestra un mensaje de estado (éxito, error, info).
         */
        function showMessage(message, type = 'info') {
            messageDiv.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800', 'bg-blue-100', 'text-blue-800');
            
            if (type === 'success') {
                messageDiv.classList.add('bg-green-100', 'text-green-800');
            } else if (type === 'error') {
                messageDiv.classList.add('bg-red-100', 'text-red-800');
            } else {
                messageDiv.classList.add('bg-blue-100', 'text-blue-800');
            }
            
            messageDiv.textContent = message;
            messageDiv.classList.remove('hidden');
        }

        /**
         * Controla el estado visual del botón de carga/análisis.
         */
        function setLoading(isLoading) {
            if (isLoading) {
                loader.classList.remove('hidden');
                buttonText.classList.add('hidden');
                extractButton.disabled = true;
                extractButton.classList.add('opacity-75', 'cursor-not-allowed');
            } else {
                loader.classList.add('hidden');
                buttonText.classList.remove('hidden');
                extractButton.disabled = false;
                extractButton.classList.remove('opacity-75', 'cursor-not-allowed');
            }
        }

        /**
         * Convierte un objeto File a una cadena base64.
         */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]); // Devuelve solo la data base64
                reader.onerror = error => reject(error);
            });
        }

        /**
         * Función fetch con reintentos y backoff exponencial para manejar throttling.
         */
        async function fetchWithRetry(url, options, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        // Solo reintentar en errores de servidor (5xx) o rate limiting (429)
                        if (response.status === 429 || response.status >= 500) {
                            throw new Error(`Server error: ${response.status}`);
                        }
                        // Errores de cliente (4xx) no se reintentan
                        const errorData = await response.json();
                        console.error("API Error (no-retry):", errorData);
                        throw new Error(errorData.error.message || `Error ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    if (i === retries - 1) throw error; // Lanzar error en el último reintento
                    // No loguear errores de reintento en la consola como errores
                    // console.log(`Retry ${i+1}/${retries} after ${delay}ms...`);
                    await new Promise(res => setTimeout(res, delay));
                    delay *= 2; // Backoff exponencial
                }
            }
        }

    </script>
</body>
</html>
